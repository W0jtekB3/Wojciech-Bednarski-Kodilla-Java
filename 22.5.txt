-- Create STATS table
CREATE TABLE STATS (
    STAT_ID INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME NOT NULL,
    STAT VARCHAR(20) NOT NULL,
    VALUE INT(11) NOT NULL
);

-- Create BESTSELLERS_COUNT view
CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) AS NUM_BESTSELLERS
FROM BOOKS
WHERE BESTSELLER = TRUE;

-- Enable event scheduler
SET GLOBAL event_scheduler = ON;

-- Create event to update bestsellers and insert into STATS
DELIMITER $$

CREATE EVENT update_bestsellers_event
ON SCHEDULE AT CURRENT_TIMESTAMP + INTERVAL 1 MINUTE
DO
BEGIN
    CALL UpdateBestsellers();

    INSERT INTO STATS (STAT_DATE, STAT, VALUE)
    SELECT NOW(), 'BESTSELLERS', NUM_BESTSELLERS
    FROM BESTSELLERS_COUNT;

    DROP EVENT IF EXISTS update_bestsellers_event;
END $$

DELIMITER ;
